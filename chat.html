<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Devaprise Chat</title>
    <script src="https://cdn.firebase.com/js/client/1.0.15/firebase.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/chat.css">
    <link href='http://fonts.googleapis.com/css?family=Muli|Roboto' rel='stylesheet' type='text/css'>
</head>
<body>
    <div class="chat-app">
        <h1><marquee>Welcome to the Devaprise Chat!</marquee></h1>
        <div id="comments-box"></div>
        <form id="post-area">
            <textarea id="text-area" placeholder="Type your comment here!"></textarea>
            <input id="post-comment" type="button" value="Post Comment" />
            <div id="name-changer">Name:
                <span class="my-name"></span>
                <input id="changename" type="button" value="Change Name" />
            </div>
        </form>
    </div>
<script type="text/javascript">
    var stat = 1;
    var username = "Guest";
    var chatDataRef = new Firebase('https://luminous-torch-6675.firebaseio.com/');
    $('#text-area').focus();
    $(".my-name").html(username);



    $('#changename').click(function(){
        var entered = prompt("Enter your name:", username);
        if (entered.length >= 20) {
            alert("Name must be less than 20 characters.")
        } else {
            username = entered;
        }
        $(".my-name").html(username);
    });

    chatDataRef.limit(100).on('child_added', function(snapshot) {
        stat = 2;
        var comment = snapshot.val();
        if (!comment.name) {
            return;
        }

        $('#comments-box').append($('<div class="comment"/>').html($('<div class="name"/>').text(comment.name)).append($('<div class="date"/>').text(comment.date)).append($('<div class="text"/>').text(comment.text)));
        $('#comments-box')[0].scrollTop = $('#comments-box')[0].scrollHeight;
    });

    var getTime = function() {
        var date = new Date;
        var hour = date.getUTCHours();
        var min = date.getUTCMinutes();
        var sec = date.getUTCSeconds();
        var time = hour+":"+(min<10? "0"+min : min)+":"+(sec<10? "0"+sec : sec)+" UTC";
        return time;
    }
    var postComment = function() {
        var time = getTime();
        var text = $('#post-area > #text-area').val();

        if (text.indexOf('<script>')!== -1) {
            alert("<script> tag not allowed.");
            return;
        }
        if (text === "") {
            alert("Please type something into the comment box.");
            return;
        }
        chatDataRef.push({name: username, date: time, text: text});
        $('#text-area').val("");
        $('#text-area').focus();
    };

    $('#post-comment').click(function() {
        postComment();
    });
    var updateTime = function() {
        if (stat === 2) {
            var time = getTime();
            $('#status').html(time);
        }
    }
    window.setInterval(updateTime, 100);

    $('#text-area').keydown(function(k) { if (k.which == 18) { postComment();} });
        </script>
    </body>
</html>